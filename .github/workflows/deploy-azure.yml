name: Build and Deploy to Azure Container Apps

on:
  push:
    branches: ["main"]

env:
  RESOURCE_GROUP: rg-mlops-car-price
  ACR_NAME: gradascentacrmlops          # <-- change if you used a different ACR name
  CONTAINERAPP_ENV: caenv-mlops-car-price
  CONTAINERAPP_NAME: car-price-app
  IMAGE_NAME: car-price-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and push image to ACR (using az acr build)
      run: |
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .

    - name: Deploy to Azure Container Apps
      run: |
        IMAGE="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"

        # Create app if it doesn't exist
        az containerapp show \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          >/dev/null 2>&1 || \
        az containerapp create \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --environment ${{ env.CONTAINERAPP_ENV }} \
          --image $IMAGE \
          --ingress external \
          --target-port 8501 \
          --transport auto \
          --min-replicas 0 \
          --max-replicas 1 \
          --cpu 0.25 \
          --memory 0.5Gi \
          --registry-server ${{ env.ACR_NAME }}.azurecr.io \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }}

        # Update app to new image on every push
        az containerapp update \
          --name ${{ env.CONTAINERAPP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image $IMAGE
